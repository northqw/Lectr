name: Build Desktop Apps

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate app icons configuration
        shell: bash
        run: |
          node -e "
            const fs = require('node:fs');
            const pkg = require('./package.json');
            const build = pkg.build || {};
            const requiredPaths = [
              build.icon,
              build?.linux?.icon,
              build?.win?.icon,
              build?.mac?.icon,
              build?.nsis?.installerIcon,
              build?.nsis?.uninstallerIcon
            ];
            for (const value of requiredPaths) {
              if (!value || typeof value !== 'string') {
                console.error('Missing icon config in package.json build section');
                process.exit(1);
              }
              if (!fs.existsSync(value)) {
                console.error('Icon file not found:', value);
                process.exit(1);
              }
            }
          "

      - name: Build renderer
        run: npm run build

      - name: Build desktop package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
        shell: bash
        run: |
          publish_mode=never
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            publish_mode=always
          fi

          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            npx electron-builder --linux AppImage --publish "${publish_mode}"
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            npx electron-builder --win nsis --publish "${publish_mode}"
          else
            npx electron-builder --mac dmg zip --publish "${publish_mode}"
          fi

      - name: Collect distributables only
        shell: bash
        run: |
          mkdir -p artifacts
          shopt -s nullglob

          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            files=(release/*.AppImage release/*.deb release/*.rpm release/*.snap release/*.tar.gz)
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            files=(release/*.exe release/*.msi release/*.zip)
          else
            files=(release/*.dmg release/*.pkg release/*.zip)
          fi

          for file in "${files[@]}"; do
            cp -v "$file" artifacts/
          done

          if [ -z "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "No distributable files were found in release/"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lectr-${{ matrix.os }}
          path: artifacts/**
          compression-level: 9
          if-no-files-found: error
